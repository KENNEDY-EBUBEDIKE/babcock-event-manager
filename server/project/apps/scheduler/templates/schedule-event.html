{% extends 'blank.html' %}
{% block title %}
	<title>BABCOCK | SCHEDULE</title>
{% endblock %}


{% block content %}
{% load static %}
  {% csrf_token %}

    <!-- Content Header (Page header) -->
      <section class="content-header">
        <h1>
          Event Schedule Calendar
          <small>Events Control panel</small>
        </h1>
        <ol class="breadcrumb">
          <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
          <li class="active">Calendar</li>
        </ol>
      </section>

      <!-- Main content -->
      <section class="content">
        <div class="row">
          <div class="col-md-3">
            <div class="box box-solid">
              <div class="box-header with-border">
                <h4 class="box-title">Draggable Events</h4>
              </div>
              <div class="box-body">
                <!-- the events -->
                <div id="external-events">
                  <div class="external-event bg-fuchsia">
                    <span class="title">DEMO EVENT</span>
                    <span hidden class="start">12:30 PM</span>
                  </div>
                  <div class="checkbox">
                    <label for="drop-remove">
                      <input type="checkbox" id="drop-remove">
                      remove after drop
                    </label>
                  </div>
                </div>
              </div>
              <!-- /.box-body -->
            </div>
            <!-- /. box -->
            <div class="box box-solid">
              <div class="box-header with-border">
                <h3 class="box-title">Create Event</h3>
              </div>
              <div class="box-body">
                <div class="btn-group" style="width: 100%; margin-bottom: 10px;">

                  <!--<button type="button" id="color-chooser-btn" class="btn btn-info btn-block dropdown-toggle" data-toggle="dropdown">Color <span class="caret"></span></button>-->
                  <ul class="fc-color-picker" id="color-chooser">
                    <li><a class="text-aqua" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-blue" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-light-blue" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-teal" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-yellow" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-orange" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-green" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-lime" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-red" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-purple" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-fuchsia" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-muted" href="#"><i class="fa fa-square"></i></a></li>
                    <li><a class="text-navy" href="#"><i class="fa fa-square"></i></a></li>
                  </ul>
                </div>
                <div class="input-group">
                  <input id="new-event-title" type="text" class="form-control" placeholder="Event Title">
                  <input id="new-event-date" type="date" class="form-control" placeholder="Event Time">
                  <input id="new-event-time" type="time" class="form-control" placeholder="Event Time">

                  <div class="input-group-btn">
                    <button id="add-new-event" type="button" class="btn btn-primary btn-flat">Add</button>
                  </div>
                </div>
                <div class="checkbox">
                    <label for="add_immediately">
                      <input type="checkbox" id="add_immediately">
                      Add Straight to Calendar
                    </label>
                </div>
              </div>
            </div>
          </div>
          <!-- /.col -->
          <div class="col-md-9">
            <div class="box box-primary">
              <div class="box-body no-padding">

                <!-- THE CALENDAR -->
                <div id="calendar"></div>
              </div>
              <!-- /.box-body -->
            </div>
            <!-- /. box -->
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->
      </section>
      <!-- /.content -->
{% endblock %}

{% block extra_script %}

  <script>
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  </script>
  <!-- Page specific script -->
  <script>
    let allEvents;
    getEvents = ()=>{
      fetch('/api/scheduler/events')
      .then(response => response.json())
      .then(data => {
          allEvents = data.events;
          eventsReady();
      });

    }

    //  Get Events from Backend
    getEvents()

    function eventsReady() {
      $(function () {

      /* initialize the external events
       -----------------------------------------------------------------*/
      function init_events(ele) {
        ele.each(function () {

          // create an Event Object (http://arshaw.com/fullcalendar/docs/event_data/Event_Object/)
          // it doesn't need to have a start or end
          var eventObject = {
            title: $.trim($(this).find('span.title').text()), // use the element's text as the event title
            start: $.trim($(this).find('span.start').text()),
          }

          // store the Event Object in the DOM element, so we can get to it later
          $(this).data('eventObject', eventObject)

          // make the event draggable using jQuery UI
          $(this).draggable({
            zIndex        : 1070,
            revert        : true, // will cause the event to go back to its
            revertDuration: 0  //  original position after the drag
          })

        })
      }

      init_events($('#external-events div.external-event'))

      /* initialize the calendar
       -----------------------------------------------------------------*/
      $('#calendar').fullCalendar({
        header    : {
          left  : 'prev,next today',
          center: 'title',
          right : 'month,agendaWeek,agendaDay'
        },
        buttonText: {
          today: 'today',
          month: 'month',
          week : 'week',
          day  : 'day'
        },
        // events From server
        events    : allEvents,
        editable  : true,
        droppable : true, // this allows things to be dropped onto the calendar !!!
        drop      : function (date, allDay) { // this function is called when something is dropped

          // retrieve the dropped element's stored Event Object
          let originalEventObject = $(this).data('eventObject')

          // we need to copy it, so that multiple events don't have a reference to the same object
          let copiedEventObject = $.extend({}, originalEventObject)

          // assign it the date that was reported
          copiedEventObject.start           = Date.parse(date.toString())
          copiedEventObject.allDay          = allDay
          copiedEventObject.backgroundColor = $(this).css('background-color')
          copiedEventObject.borderColor     = $(this).css('border-color')

          // render the event on the calendar
          addEvent(copiedEventObject.title, Date.parse(date.toString()), $(this).css('background-color'), $(this).css('border-color'))
          .then(event => {
              console.log("Event Scheduled successfully");
              copiedEventObject.id = event.id
              originalEventObject.id = event.id
              $('#calendar').fullCalendar('renderEvent', copiedEventObject, true)
              toastr["success"]("Event Scheduled successfully","SUCCESS!")
          })
          .catch(error => {
              toastr["error"](error ,"Error!");

          });

          // is the "remove after drop" checkbox checked?
          if ($('#drop-remove').is(':checked')) {
            // if so, remove the element from the "Draggable Events" list
            $(this).remove()
          }

        },
        eventResize: function(event, delta, revertFunc) {
          //push to backend
          editEvent(event)
        },
        eventDrop: function(event, delta, revertFunc) {
          //push to backend
          editEvent(event)

        },
        eventClick: function(event, jsEvent, view) {
          // Calls this function when an event is clicked
          $('#calendar').fullCalendar('getCalendar').removeEvents(event.id);
          deleteEvent(event);
        }
      })


      /* ADDING EVENTS  START*/
      let currColor = '#050462' //Red by default

      //Color chooser button
      let colorChooser = $('#color-chooser-btn')
      $('#color-chooser > li > a').click(function (e) {
        e.preventDefault()
        //Save color
        currColor = $(this).css('color')
        //Add color effect to button
        $('#add-new-event').css({ 'background-color': currColor, 'border-color': currColor })
      })

      $('#add-new-event').click(function (e) {
        e.preventDefault()
        //Get value and make sure it is not null
        let event_title = $('#new-event-title').val()
        let event_date = $('#new-event-date').val()
        let event_time = $('#new-event-time').val()

        if (event_title.length === 0 || event_date.length === 0 || event_time.length === 0) {
          return
        }

        //Create events
        let event = $('<div />')
        event.css({
          'background-color': currColor,
          'border-color'    : currColor,
          'color'           : '#fff'
        }).addClass('external-event')
        let title = $('<span />').addClass('title').appendTo(event);
        let time = $('<span />').addClass('time').appendTo(event);
        let date = $('<span />').addClass('date').appendTo(event);

        title.html(event_title)
        date.html(event_date).prop('hidden', true);

        const [year, month, day] = event_date.split('-');
        const [hours, minutes] = event_time.split(":");


        const dateObj = new Date();
        dateObj.setFullYear(year);
        dateObj.setMonth(month - 1); // Months are zero-indexed
        dateObj.setDate(day);
        dateObj.setHours(hours);
        dateObj.setMinutes(minutes);

        const timezoneOffset = 60; // Time zone offset in minutes (GMT+1)
        const timeStamp = dateObj.getTime() + timezoneOffset * 60 * 1000; // Convert to GMT+1

        time.html(timeStamp).prop('hidden', true);

        $('#external-events').prepend(event)


        let newEventObject = {
            title: $.trim(event_title),
            start: $.trim(timeStamp),
        }
        let copiedEventObject = $.extend({}, newEventObject)
        copiedEventObject.start           = timeStamp
        copiedEventObject.backgroundColor = $(this).css('background-color')
        copiedEventObject.borderColor     = $(this).css('border-color')

        if ($('#add_immediately').is(':checked')) {

          // Push to backend
          addEvent(copiedEventObject.title, timeStamp, $(this).css('background-color'), $(this).css('border-color'))
          .then(event => {
              copiedEventObject.id = event.id
              // Add to the calendar
              $('#calendar').fullCalendar('renderEvent', copiedEventObject, true)
              toastr["success"]("Event Scheduled successfully","SUCCESS!")
          })
          .catch(error => {
              toastr["error"](error ,"Error!");

          });
        }

        //Add to draggable(s)
        init_events(event)

        //Remove event from text input
        $('#new-event-title').val('')
        $('#new-event-date').val('')
        $('#new-event-time').val('')
      })

      /* ADDING EVENTS  END*/
    })
    }
  </script>

  <script>
    addEvent = (title, start, backgroundColor, borderColor) => {
      return new Promise((resolve, reject) => {
          $.ajax({
              url: "/api/scheduler/event/",
              type: 'POST',
              data: {
                  'title': title,
                  'background_color': backgroundColor,
                  'border_color': borderColor,
                  'start': start,
              },
              dataType: "json",
              headers: {'X-CSRFToken': csrftoken},
              mode: 'same-origin',
              success: function (response) {
                  if (response.success) {
                      console.log(response.message);
                      resolve(response.event);
                  } else {
                      console.log(response.message);
                      reject(response.message);
                  }
              },
              error: function (xhr, status, error) {
                  reject(error);
              }
          });
      });
    };
    editEvent = (event)=>{
      $.ajax({
            url: "/api/scheduler/event/",
            type: 'PATCH',
            data: {
                'title': event.title,
                'id': event.id,
                'start': event.start.valueOf(),
                'end': event.end?.valueOf(),
            },
            dataType: "json",
            headers: {'X-CSRFToken': csrftoken},
            mode: 'same-origin',
            success: function (response) {
                if (response.success) {
                    toastr["success"](response.message,"SUCCESS!")
                } else {
                    toastr["error"](response.message,"Error!")
                }
            },
        })
    }
    deleteEvent = (event)=>{
      $.ajax({
            url: "/api/scheduler/event/",
            type: 'DELETE',
            data: {
                'id': event.id,
            },
            dataType: "json",
            headers: {'X-CSRFToken': csrftoken},
            mode: 'same-origin',
            success: function (response) {
                if (response.success) {
                    toastr["success"](response.message,"SUCCESS!")
                } else {
                    toastr["error"](response.message,"ERROR!")
                }
            },
        })
    }
  </script>
{% endblock %}
